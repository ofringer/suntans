\section{SUNTANS Examples} \label{sec:examples}

\subsection{Running the examples}

Each example is located in one of the directories in the \verb+examples+ directory in
the main source directory.  As an example, consider the internal waves example located
in \verb+examples/iwaves+.  The internal waves simulation in this directory is defined by the following files
in the \verb+examples/iwaves+ directory:
\begin{itemize}
\item \verb+initialization.c+: Initial conditions
\item \verb+boundaries.c+: Boundary conditions
\item \verb+rundata/suntans.dat+: Parameters
\item \verb+rundata/pslg.dat+: Planar straight line graph
\end{itemize}
All examples are run in the same way.
The makefile in the \verb+iwaves+ directory compiles and links the initial and boundary condition
files with the main sun executable in the source directory.  Then it copies the parameter
file (\verb+suntans.dat+) and the planar straight line graph file to the directory \verb+data+ in
the particular example directory.  Then the main sun executable is run with
\begin{verbatim}
../../sun -t -g -s -vv --datadir=data
\end{verbatim}
where the particular flags may depend on the example, but the executable is run from
the main source directory and the data is local to the particular examples directory.
In order to compile and run an example, enter that example
directory and type \verb+make test+.  This will run the example simulation and place
the output data into the data irectory in the examples directory.
While the simulation is running, the data can be viewed from another command line
from the main source directory with
\begin{verbatim}
./sunplot --datadir=examples/iwaves/data
\end{verbatim}
It is important that you run \verb+make clobber+ between successive tests in other
test directories to ensure that you are recompiling the \verb+../../sun+ executable
with the correct initial and boundary condition files each time.  Without clobbering,
rerunning \verb+make test+ will run the test case while only reflecting changes in \verb+suntans.dat+.
Therefore, it is not necessary to clobber if the same test is being run with different 
parameters in \verb+suntans.dat+.

\subsection{Time accuracy} \label{sec:timeaccuracy}

This example is in the \verb+examples/accuracy+ directory and it
serves to verify the time accuracy of SUNTANS.  Details of the time accuracy
of SUNTANS and this particular test case can be found in Fringer\etal~\cite{FRINGER[2005]}.
The parameter file is given by
\verb+suntans.in+, which lacks the paramters \verb+dt+ and \verb+nsteps+.  These
are copied to the actual parameter file \verb+data/suntans.dat+ upon running the
script \verb+accuracy.sh+, which runs SUNTANS with different time steps and computes
accuracy criteria using the \verb+accuracy.c+ code.  This code is a good exmaple
of how to read in and analyze SUNTANS data using the C programming language.  More
details are given below.

\subsubsection{Grid}

The domain is 100 m long and 100 m deep, and it
uses 100 vertical levels and 100 equilateral triangles, as defined in the planar
straight line graph file \verb+rundata/oned.dat+, which was created with the
\verb+onedgrid.m+ m-file which can be downloaded from 

\medskip
\noindent
\mfiledownload.

\medskip
\noindent
All boundary edges are of type 1 (closed) boundaries.
The depth is constant and is defined in \verb+initialization.c+ in the 
\verb+ReturnDepth+ function with the line
\begin{verbatim}
return 100;
\end{verbatim}
Note that in order for this depth to be specified, the \verb+IntDepth+ parameter must
be set to 0 in the \verb+suntans.dat+ parameter file.

\subsubsection{Initial conditions}

The initial velocity field is quiescent, the initial free surface height is 0,
and the initial density distribution is defined in the function \verb+ReturnSalinity+
in \verb+initialization.c+ as
\begin{verbatim}
  return -.03*tanh(2.0*2.6467/20*(z+50-cos(PI*x/100)));
\end{verbatim}
Because $\beta=1$ in \verb+suntans.dat+ (the parameter \verb+beta+), this is also the initial density 
distribution, since $(\rho-\rho_0)/\rho_0 = \beta(s-s_0)$ More generally, then, 
this density distribution is given by
\[
\frac{\rho}{\rho_0} = -\frac{1}{2}\frac{\Delta\rho}{\rho_0}
\tanh\left[\frac{2\mbox{tanh}^{-1}(\alpha)}{\delta}\left(z+\frac{D}{2}-\zeta\right)\right]\,,
\]
where
\begin{itemize}
\item $\Delta\rho/\rho_0=0.06$: Density difference between layers.
\item $\alpha=0.99$: Parameter that defines interface extent.
\item $\delta=20$ m: Interface thickenss.
\item $z$: Vertical coordinate
\item $D=100$ m: Depth
\item $\zeta = \cos(\pi x/L)$: Interface profile, where $L=100$ m is the domain length.
\end{itemize}
and is shown in Figure \ref{fig:initdens}. 
\insertfig{1}{figures/initdens}{Initial density distribution in $x$-$z$ (a) and as a profile at $x=L/2$ (b)
for the time accuracy test case.}{fig:initdens}

\subsubsection{Boundary conditions}

Because all boundaries of the planar
straight line graph (\verb+rundata/oned.dat+) are of type 1, the functions in the \verb+boundaries.c+ file are
not used in this example.

\subsubsection{Running the test}

The accuracy test case is run at the command line with
\begin{verbatim}
make test
\end{verbatim}
This will compile the local initial and boundary condition files and link them with the
executable \verb+../../sun+.  The script \verb+accuracy.sh+ loops through different
time step sizes given by $\Delta t_n = \Delta t_0/2^n$, with $n=0,1,\dots,5$, where
$\Delta t_0 = 0.1$ s.  If the reference solution is given by the solution $\phi^{ref}$
with a time step size of $\Delta t_0/32$, then the error between a solution using
$\Delta t=\Delta t_0/2^n$ and the 
reference solution can be calculated with
\[
Error(n)^2 = \frac{\sum_{i=0}^{Nc-1}\sum_{k=0}^{N_{kmax}-1} \left(\phi_{i,k}-\phi^{ref}_{i,k}\right)^2}
{\sum_{i=0}^{Nc-1}\sum_{k=0}^{N_{kmax}-1} \left(\phi^{ref}_{i,k}\right)^2}\,.
\]
Since this is a second-order method, we must have $Error(n)/Error(n-1)=4$ since the time step size
for $Error(n)$ is double that of $Error(n-1)$.  Therefore, $Error(n)/Error(0) = 4^n = (\Delta t_0/\Delta t_n)^2$,
$n=0,1,\dots,4$.  After
the \verb+accuracy.sh+ script finishes, the results are analyzed with the code in \verb+accuracy.c+,
which computes $Error(n)$.  The output of this code is given by
\begin{verbatim}
Error results (Error(n)/Error(0)):

Your results:
--------------------------------------------------
dt0/dt  U       W       S       Q       Q0      h
--------------------------------------------------
1       1.0     1.0     1.0     1.0     1.0     1.0
2       3.9     3.9     4.0     4.1     1.2     4.0
4       15.6    15.5    16.2    16.4    2.1     16.4
8       65.1    64.8    68.1    68.9    4.4     69.1
16      324.7   323.5   340.6   344.8   12.8    345.9

Reference results:
1       1.0     1.0     1.0     1.0     1.0     1.0
2       3.9     3.9     4.0     4.1     1.2     4.0
4       15.6    15.5    16.2    16.4    2.1     16.4
8       65.1    64.8    68.1    68.9    4.4     69.1
16      324.7   323.5   340.6   344.8   12.8    345.9

Difference (relative):
1       0.00    0.00    0.00    0.00    0.00    0.00
2       -0.00   0.00    0.00    0.00    0.00    -0.00
4       -0.00   0.00    0.00    0.00    0.00    -0.00
8       -0.00   0.00    0.00    0.00    0.00    -0.00
16      -0.00   0.00    0.00    0.00    0.00    -0.00
\end{verbatim}
The code outputs the results from the current run, then displays the results that
have been saved from a working version of this simulation, and then plots the relative
difference between your results and the stored results as
\[
\mbox{Difference} = \frac{\mbox{Your($Error(n)/Error(0)$)} - \mbox{Stored($Error(n)/Error(0)$)}}
{\mbox{Stored($Error(n)/Error(0)$)}}\,.
\]
Each column represents:
\begin{itemize}
\item \verb+dt0/dt+: $\Delta t_0/\Delta t^n$, $n=0,1,\dots 4$
\item \verb+U+: Horizontal velocity.
\item \verb+W+: Vertical velocity
\item \verb+S+: Salinity (or density, since $\beta=1$).
\item \verb+Q+: Nonhydrostatic pressure using the second-order Adams-Bashforth extrapolation
using the last two time steps (for details see Fringer\etal~\cite{FRINGER[2005]}).
\item \verb+Q0+: Nonhydrostatic pressure without the extrapolation of \verb+Q+.
\item \verb+h+: Free surface.
\end{itemize}
The first time you download and run the examples, the results
you obtain should be identical to the stored results since they were obtained with the
same code, and the relative difference should be identically zero.  Changing parts of the
code may or may not affect the accuracy, but if it does then this will be reflected by
nonzero values for the relative difference.

\subsection{Lock exchange} \label{sec:lockexchange}

This example is in the \verb+examples/lockexchange+ directory and it 
demonstrates the nonhydrostatic internal lock exchange problem.  Due to the
coarseness of the grid being used, numerical diffusion acts to limit the formation of
the KH billows along the interface.  These billows can easily be obtained by increasing
the resolution, following the simulation outlined by Fringer\etal~\cite{FRINGER[2005]}.

\subsubsection{Grid}

The grid in this example is obtained with the 
\verb+onedgrid.m+ m-file which can be downloaded from 

\medskip
\noindent
\mfiledownload.

\medskip
\noindent
In this case, the grid contains 200 cells in the horizontal and 20 in the vertical, with
a length of 100 m and a depth of 20 m.  This constant depth is specified in \verb+initialization.c+
in the function \verb+ReturnDepth+ with the line
\begin{verbatim}
return 20;
\end{verbatim}
Note that in order for this depth to be specified, the \verb+IntDepth+ parameter must
be set to 0 in the \verb+suntans.dat+ parameter file.  As shown in Figure \ref{fig:stretched},
this grid is stretched in the
vertical in order to provide extra resolution at the bottom boundary.  This is done by
specifying a negative stretching factor of $r=-1.025$ (\verb+suntans.dat: rstretch = -1.025+),
which causes each grid layer to be 1.025 times thicker than the layer beneath it.  
\insertfig{0.8}{figures/stretched}{Depiction of the vertically stretched grid for the lock exchange
problem.  Every fourth vertical cell face plotted for clarity.}{fig:stretched}

\subsubsection{Initial conditions}

The initial velocity field is quiescent, the initial free surface height is 0,
and the initial density distribution is defined in the function \verb+ReturnSalinity+
in \verb+initialization.c+ as
\begin{verbatim}
  return -.001*tanh(2.0*2.6467/5*(x-50.0));
\end{verbatim}
Because $\beta=1$ in \verb+suntans.dat+ (the parameter \verb+beta+), this is also the initial density 
distribution, since $(\rho-\rho_0)/\rho_0 = \beta(s-s_0)$ More generally, then, 
this density distribution is given by
\[
\frac{\rho}{\rho_0} = -\frac{1}{2}\frac{\Delta\rho}{\rho_0}
\tanh\left[\frac{2\mbox{tanh}^{-1}(\alpha)}{\delta}\left(x-\frac{L}{2}\right)\right]\,,
\]
where
\begin{itemize}
\item $\Delta\rho/\rho_0=2\times 10^{-3}$: Density difference.
\item $\alpha=0.99$: Parameter that defines interface extent.
\item $\delta=5$ m: Interface thickenss.
\item $x$: Horizontal coordinate.
\item $L=100$ m: Length
\end{itemize}
and is shown in Figure \ref{fig:initlock}. 
\insertfig{0.8}{figures/initlock}{Initial density distribution in $x$-$z$ (a) and as a profile at $x=L/2$ (b)
for the lock exchange test case.}{fig:initlock}

\subsubsection{Boundary conditions}

Because all boundaries of the planar
straight line graph (\verb+rundata/oned.dat+) are of type 1, the functions in the \verb+boundaries.c+ file are
not used in this example.

\subsubsection{Running the test}

This test case is run with the command
\begin{verbatim}
make test
\end{verbatim}
The simulation runs for 500 time steps (\verb+suntans.dat: nsteps = 500+) with a time step size of 0.2 s (\verb+suntans.dat: dt = 0.2+).
For this grid, given that the Voronoi distance for the equilateral triangles with sides of length $\Delta x=L/200$
is $D_g = \Delta x/\sqrt{3} = 0.2887$ m, and the maximum velocity is roughly $u_{max}=0.5$ m s$^{-1}$ (it actually
never exceeds $0.44$ m s$^{-1}$),
the horizontal Courant number is $C_x=u_{max}\Delta t/D_g = 0.35$, and the vertical Courant number is
$C_z=w_{max}\Delta t/\Delta z_{min}=0.2\mbox{m s}^{-1} 0.2\mbox{s}/0.78 m=0.05$.  Because central differencing
is employed for advection of momentum (\verb+suntans.dat: nonlinear = 2+), 
the horizontal grid Peclet number must satisfy the one-dimensional stability criterion which requires
that  $Pe_{\Delta x}<2/C_x$.  This is an approximation and is not as restrictive as it should be for multidimensional,
unstructured-grid problems, but it serves as a good approximation (See Fletcher~\cite{FLETCHER[1997]} for details).
For the horizontal stability, then, this requires that $\nu_H\ge u_{max}^2\Delta t/2 = 0.025$ m$^2$ s$^{-1}$ (\verb+suntans.dat: nuH = 0.025+).
Likewise, for vertical stability, $\nu = 0.016$  m$^2$ s$^{-1}$ (\verb+suntans.dat: nu = 0.016+).

The results can be viewed with the \verb+sunplot+ gui from the main source directory with
\begin{verbatim}
./sunplot --datadir=examples/lockexchange/data
\end{verbatim}
This will open up a planview of the one-dimensional grid of equilateral triangles, showing that
there are 26 (1+\verb+nsteps+/\verb+ntout+) time steps to plot.  To view the
profile plot, depress the \button{Profile} button with the middle mouse button.  The last time step
of the velocity vectors along with the salinity field can be viewed with the following buttons:
\begin{enumerate}
\item Right mouse on \button{$-->$}:  To get to last time step.
\item Left mouse on \button{Vectors}: Turn on velocity vectors.
\item 3$\times$ Right mouse on \button{Vectors}: Increase vector length by a factor of 8.
\item 2$\times$ Left mouse on \button{$>$}: Increase \verb+iskip+ to 3 to plot every third vector for clarity.
\end{enumerate}
The display should appear as it does in Figure \ref{fig:lock}.
\insertfig{0.6}{figures/lock}{Sunplot display of the lock exchange example after 500 time steps.}{fig:lock}

\subsection{Boundary condition example} \label{sec:boundary_ex}

This example is in the \verb+examples/boundaries+ directory and it simulates a simplified
river plume in order to demonstrate the use of velocity as well as scalar boundary conditions
at the inflow and the outflow.

\subsubsection{Grid}

The two-dimensional grid of equilateral triangles is created with the m-file \verb+twodgrid.m+,
which can be downloaded from

\medskip
\noindent
\mfiledownload.

\medskip
\noindent
As shown in Figure \ref{fig:plumegrid}, it is 3 km long by 1 km wide with a total of 1215 equilateral triangles
with edge lengths of 75 m.  The eastern and southern boundaries
are marked as type 2 edges.  These will be specified in \verb+boundaries.c+.  The depth is
10 m and is specified in \verb+initialization.c+ as
\begin{verbatim}
return 10;
\end{verbatim}
There are 10 vertical levels (\verb+suntans.dat: Nkmax = 10+).
\insertfig{.8}{figures/plumegrid}{Two-dimensional planview of the river plume grid, showing the
boundary edges of type 2 in bold.}{fig:plumegrid}

\subsubsection{Initial conditions}

As specified in \verb+initialization.c+, the initial conditions are straightforward in
that all quantities are initialized to zero except the temperature field, which is set to 1
everywhere.  It is treated as a passive
tracer when $\gamma=1$ (\verb+suntans.dat: gamma = 1+).

\subsubsection{Boundary conditions}

\begin{itemize}
\item[] {\bf Eastern Boundary: open}\\
The eastern boundary fluxes normal to the faces are specified while values used for
advection of momentum and scalars are upwinded
\begin{itemize}
\item[] {\bf Boundary fluxes}\\
As specified in \verb+boundaries.c+, the eastern boundary is an open boundary and employs the
linearized boundary condition on the velocity with
\[ u_b = -h_b\sqrt{\frac{g}{d}} \,,.\]
where $h_b$ is the free-surface height, $g$ is gravitational acceleration, and $d$ is
the depth, and the minus sign implies flux out of the domain when $h_b>0$.
This is enforced in the \verb+OpenBoundaryFluxes+ function with the lines
\begin{verbatim}
if(grid->yv[ib]>50) {
   for(k=grid->etop[j];k<grid->Nke[j];k++) 
     ub[j][k]=-phys->h[ib]*sqrt(GRAV/grid->dv[ib]);
...
\end{verbatim}
The \verb+ib+ index is the index of the cell adjacent to the boundary, and the if-statement
is required to distinguish this eastern outflow boundary from the southern boundary.  Note
that because the edge lengths are $\Delta x = 75$ m, this implies that the distance between the Voronoi points
and the boundary edges is $\Delta x/(2\sqrt{3})=21.7$ m.  Therefore, we know that if the location
of the boundary Voronoi point \verb+ib+ adjacent to a boundary edge \verb+j+ 
is greater than $50$ m, it must be the eastern boundary.
\item[] {\bf Boundary velocities}\\
At the eastern open boundary, the boundary velocities which are used for advection of momentum
out of the domain are given by the upwind velocity components.  This is specified in the
\verb+BoundaryVelocities+ function with the lines
\begin{verbatim}
if(grid->yv[ib]>50) {
   for(k=grid->etop[j];k<grid->Nke[j];k++) {
      phys->boundary_u[jptr-grid->edgedist[2]][k]=
                                  phys->uc[ib][k];
      phys->boundary_v[jptr-grid->edgedist[2]][k]=
                                  phys->vc[ib][k];
      phys->boundary_w[jptr-grid->edgedist[2]][k]=
                             0.5*(phys->w[ib][k]+phys->w[ib][k+1]);
   } 
\end{verbatim}
Because the flux of momentum is calculated at the vertical centers of the vertical faces,
the upwind vertical velocity is interpolated from the upper (k) and lower (k+1) faces of the kth cell.
\item[] {\bf Boundary scalars}\\
The outflow conditions on the scalars are imposed by specified the upwind scalar quantity
at the outflow face.  This is set in the function \verb+BoundaryScalars+ with the lines
\begin{verbatim}
for(k=grid->ctop[ib];k<grid->Nk[ib];k++) {
   phys->boundary_T[jptr-grid->edgedist[2]][k]=phys->T[ib][k];
   phys->boundary_s[jptr-grid->edgedist[2]][k]=phys->s[ib][k];
}
\end{verbatim}
\end{itemize}
\end{itemize}

\begin{itemize}
\item[] {\bf Southern boundary: specified}\\
All quantities at the southern boundary are specified.  Since this example simulates a river
inflow, the velocity and scalar fields are specified along only part of the southern boundary, while
the rest of the boundary is kept at zero inflow to represent a solid boundary.  This requires if-statements to
determine which of the southern boundary edges fall between the extent of the inflowing river.
An alternative is to set the markers of the southern boundary edges that fall within the boundaries
of the river to 2, and the rest to 1. 
\begin{itemize}
\item[] {\bf Boundary fluxes}
Because the velocity components at the southern boundary are specified, the incoming boundary
flux is computed in \verb+OpenBoundaryFluxes+ using the velocity components specified in the \verb+BoundaryVelocities+ function,
but only within the extent of the 300 m wide river, which is defined for $900 < x < 1200$ m (4 cell faces), as in:
\begin{verbatim}
if(grid->xv[ib]>900&&grid->xv[ib]<1200)
  for(k=grid->etop[j];k<grid->Nke[j];k++) 
    ub[j][k]=
      phys->boundary_u[jptr-grid->edgedist[2]][k]*grid->n1[j]+
      phys->boundary_v[jptr-grid->edgedist[2]][k]*grid->n2[j];
\end{verbatim}
Since \verb+boundary_u+ and \verb+boundary_v+ store the inflow velocity components, then this
is setting the flux at the inflow to the normal component of the velocity at the inflow, i.e.
\[
U_{inflow} = {\mathbf u}_{inflow}\cdot {\mathbf n}_{inflow}\,,
\]
where ${\mathbf n}_{inflow}$ is, by convention, the inward pointing normal at the boundary face.
\item[] {\bf Boundary velocities}
The north-south velocity is specified at the inflow for $900 < x < 1200$ over a specified depth,
which represents the river inflow, such that
\begin{eqnarray}
u_{inflow} &=& 0\,,\nonumber\\
v_{inflow} &=& \left\{\begin{array}{ll}
                    \mbox{amp} & z>-D_r \\
		    0 & \mbox{otherwise\,,}
		    \end{array}
             \right.\nonumber\\
w_{inflow} &=& 0\,.\nonumber
\end{eqnarray}
where amp is specified in \verb+suntans.dat+ as $0.01$ m s$^{-1}$, and
$D_r=3$ m is the inflow depth.  In \verb+boundaries.c+, this inflow is implemented with
\begin{verbatim}
if(grid->xv[ib]>900 && grid->xv[ib]<1200) {
  z=0;
  for(k=grid->etop[j];k<grid->Nke[j];k++) {
    z-=0.5*grid->dzz[ib][k];
    if(z>-3.0)
      phys->boundary_v[jptr-grid->edgedist[2]][k]=prop->amp;
    z-=0.5*grid->dzz[ib][k];
  }
}
\end{verbatim}
All other components are set to zero at the beginning of the main loop in the function \verb+BoundaryVelocities+
with
\begin{verbatim}
for(k=grid->etop[j];k<grid->Nke[j];k++) {
  phys->boundary_u[jptr-grid->edgedist[2]][k]=0;
  phys->boundary_v[jptr-grid->edgedist[2]][k]=0;
  phys->boundary_w[jptr-grid->edgedist[2]][k]=0;
}
\end{verbatim}
\item[] {\bf Boundary scalars}
The inflow boundary condition for the salinity (or density, when $\beta=1$) field
represents an inflow of fresh water with a density anomoly of $\Delta \rho/\rho_0=-10^{-4}$, with a surface depth of $D_r=3$ m,
such that
\[
\rho_{inflow} = \left\{\begin{array}{ll}
                    \Delta \rho & z>-D_r \\
		    0 & \mbox{otherwise\,.}
		    \end{array}
             \right.
\]
The inflow boundary condition for temperature is a no-gradient condition, and as a result the temperature
just outside the boundary is equal to that just inside the boundary.  These boundary conditions for salinity (density)
and temperature are given in \verb+boundaries.c+ as
\begin{verbatim}
if(grid->yv[ib]<50)
  if(grid->xv[ib]>1000 && grid->xv[ib]<1200)
    for(k=grid->ctop[ib];k<grid->Nk[ib];k++) {
      z-=0.5*grid->dzz[ib][k];
      if(z>-3.0) {
        phys->boundary_T[jptr-grid->edgedist[2]][k]=phys->T[ib][k];
        phys->boundary_s[jptr-grid->edgedist[2]][k]=-0.0001;
      } else {
        phys->boundary_T[jptr-grid->edgedist[2]][k]=phys->T[ib][k];
        phys->boundary_s[jptr-grid->edgedist[2]][k]=0;
      }
      z-=0.5*grid->dzz[ib][k];
    }
\end{verbatim}
\end{itemize}
\end{itemize}

\subsubsection{Running the test}

Upon typing \verb+make test+, the simulation runs for a total of 3000 time steps (\verb+suntans.dat: nsteps = 3000+)
with a time step of 60 s (\verb+suntans.dat: dt = 60+), outputting
data every 120 time steps (\verb+suntans.dat: ntout = 120+).  While the data is running you can view the
results from the main source directory with
\begin{verbatim}
./sunplot --datadir=./examples/boundaries/data
\end{verbatim}
As can be seen from the results, the river plume forms a bulge as well as a coastal current resulting from
the nonzero Coriolis parameter of $f=5\times 10^{-4}$ (\verb+suntans.dat: Coriolis_f = 5e-4+).
After 3000 time steps, the density anomoly at the upper layer is depicted in Figure \ref{fig:plume}.  This
figure was obtained using the m-file \verb+sunsurf.m+, which can be downloaded from

\medskip
\noindent
\mfiledownload.

\medskip
\noindent
If you are running this m-file from the \verb+examples/boundaries+ directory, then the plot in Figure \ref{fig:plume}
was obtained with the command
\begin{verbatim}
timestep = 26;
klevel = 1;
processor = 0;
sunsurf('s','.../data',timestep,klevel,processor);
\end{verbatim}
Note that \verb+sunsurf.m+ requires \verb+unsurf.m+. 
\insertfig{0.8}{figures/plume}{River plume example showing the salinity (density) field after 3000 time steps.}{fig:plume}

\subsection{Internal waves} \label{sec:internalwaves}

This example is found in the \verb+examples/iwaves+ directory, and it demonstrates the formation
of internal wave beams at an idealized coastal shelf break in two dimensions $x$-$z$.  The barotropic
M2 tide is forced at the western boundary, forcing tidal currents over the break and thus generating
internal wave beams.

\subsubsection{Grid}

The grid in this example is obtained with the 
\verb+onedgrid.m+ m-file which can be downloaded from 

\medskip
\noindent
\mfiledownload.

\medskip
\noindent
In this case, the one-dimensional grid contains 100 cells in the horizontal and 100 in the vertical, and
the domain is 100 km long with a maximum depth of 3000 m.  All edges are of type 1 except for the western
boundary edge, which is of type 2.
The shelf slope geometry is given by
\[
d(x) = \left\{\begin{array}{ll}
D_0 & x\le x_{mid}-L_s/2\\
D_s & x> x_{mid}+L_s/2\\
D_0 - \left(D_0-D_s\right)\left[(x-x_{mid})/L_s+\frac{1}{2}\right] & \mbox{otherwise}\,.
\end{array}\right.
\]
where
\begin{itemize}
\item[] $L_s=20$ km: Horizontal extent of slope.
\item[] $x_{mid}=65$ km: Center of slope.
\item[] $D_0=3000$ m: Maximum depth.
\item[] $D_s=500$ m: Shelf depth.
\end{itemize}
This depth profile is specified in \verb+boundaries.c+ in the function \verb+ReturnDepth+ with
\begin{verbatim}
Ls = 20000;
xmid = 65000;
D0 = 3000;
Ds = 500;
if(x<=xmid-Ls/2)
  return D0;
else if(x>xmid+Ls/2)
  return Ds;
else
  return D0-(D0-Ds)*((x-xmid)/Ls+0.5);
\end{verbatim}
As with all the present examples, in order for this depth to be specified, the \verb+IntDepth+ parameter must
be set to 0 in the \verb+suntans.dat+ parameter file, otherwise, depth data must be supplied in the
file specified by \verb+depth+ in \verb+suntans.dat+.  As shown in Figure \ref{fig:iwstretched},
this grid is stretched in the
vertical in order to provide extra resolution at the top boundary.  This is done by
specifying a positive stretching factor (as opposed to a negative stretching factor for the
bottom boundary layer, as in Section \ref{sec:lockexchange}) of $r=1.025$ (\verb+suntans.dat: rstretch = 1.025+),
which causes each grid layer to be 1.025 times thicker than the layer {\bf above} it.  
\insertfig{0.8}{figures/iwstretched}{Depiction of the bathymetry and vertically stretched grid for the 
internal waves problem. Minimum grid spacing: 6.94 m, maximum: 79.94 m.}{fig:iwstretched}

\subsubsection{Initial conditions}

The initial conditions for the internal wave problem, as specified in \verb+initialization.c+,
are quiescent velocity field, zero free-surface, and constant temperature field (the passive
tracer) of $T=1$, with an initial salinity field (or density, since
\verb+beta=1+ in \verb+suntans.dat+) of
\[
s(z) = \left\{\begin{array}{ll}
\Delta s\left(-z\right)^{\alpha_s} & z<-D_{pycnocline}\,,\\
\Delta s\left(D_{pycnocline}\right)^{\alpha_s} & \mbox{otherwise}\,,
\end{array}\right.
\]
where $\Delta s = 0.024$, $\alpha_s = 0.0187$, and $D_{pycnocline} = 20$.  These
parameters have been chosen to create a typical U.S. west coast density field.
This salinity (density) profile is 
implemented in the function \verb+ReturnSalinity+ in \verb+initialization.c+ as
\begin{verbatim}
deltaS = 0.024;
alphaS = 0.0187;
D_pycnocline = 20;

if(z<-D_pycnocline)
  return deltaS*pow(-z,0.0187);
else
  return deltaS*pow(D_pycnocline,0.0187);
\end{verbatim}

\subsubsection{Boundary conditions}

Boundary conditions are gradient-free on the temperature and salinity fields at the western
boundary.  This is implemented in the function \verb+BoundaryScalars+ in the file \verb+boundaries.c+
as
\begin{verbatim}
for(k=grid->ctop[ib];k<grid->Nk[ib];k++) {
  phys->boundary_T[jptr-grid->edgedist[2]][k]=phys->T[ib][k];
  phys->boundary_s[jptr-grid->edgedist[2]][k]=phys->s[ib][k];
}
\end{verbatim}
where \verb+ib+ is the index of the Voronoi point adjacent to the boundary edge \verb+j+.

For the velocity field, the $x$-direction velocity is specified at the western boundary
as a sinusoidally varying barotropic velocity with a $M_2$ tidal period of 12.42 hours,
and the other components are zero.  This is implemented in the function \verb+BoundaryVelocities+
in the file \verb+boundaries.c+ as
\begin{verbatim}
for(k=grid->etop[j];k<grid->Nke[j];k++) {
  phys->boundary_u[jptr-grid->edgedist[2]][k]=
        prop->amp*sin(prop->omega*prop->rtime);
  phys->boundary_v[jptr-grid->edgedist[2]][k]=0;
  phys->boundary_w[jptr-grid->edgedist[2]][k]=0;
}
\end{verbatim}
The variables \verb+amp+ and \verb+omega+ are set in \verb+suntans.dat+ 
(\verb+amp = 4+ mm s$^{-1}$ and \verb+omega = 1.4026e-4+ rad s$^{-1}$),
and \verb+rtime+ is the simulation time, in seconds.  These velocities are
then used in the \verb+OpenBoundaryFluxes+ function to compute the velocity normal
to the boundary face with 
\begin{verbatim}
for(k=grid->etop[j];k<grid->Nke[j];k++) 
  ub[j][k]=phys->boundary_u[jptr-grid->edgedist[2]][k]*grid->n1[j]+
           phys->boundary_v[jptr-grid->edgedist[2]][k]*grid->n2[j];
\end{verbatim}
Since there is only one boundary, no if-statements are required to determine if
this is an open or closed boundary condition, such as in Section \ref{sec:boundary_ex}.
More complex partially-clamped boundary conditions can be implemented that allow the internal wave
field to exit the domain while still forcing the barotropic velocity field, but this is
beyond the scope of this simplified example.

\subsubsection{Running the test}

The test case is run at the command line with the command
\begin{verbatim}
make test
\end{verbatim}
which runs the simulation for 3000 time steps (\verb+suntans.dat: nsteps = 3000+)
with a time step size of 29.808 s (\verb+suntans.dat: dt = 29.808+) for a total of
2 $M_2$ tidal periods.  This test case uses the sponge layer which is hardwired into
SUNTANS.  The parameters are set to \verb+sponge_distance = 5000+ and 
\verb+sponge_decay = 7200+ (for details see Section \ref{sec:params}).

The results can be viewed with the \verb+sunplot+ gui from the main source directory with
\begin{verbatim}
./sunplot --datadir=examples/iwaves/data
\end{verbatim}
This brings up a planview of the one-dimensional grid of equilateral triangles.  To display
the profile plot of the results, press the \button{Profile} button with the middle mouse
button and then the \button{Axis} button with the left mouse button so that the axes fill the plot window.
This will display the salinity (density) field at the first time step, as shown in Figure 
\ref{fig:iwaves1}.  Plotting the u-velocity at data steps 11 and 21 will display the horizontal
velocity field after one and two periods of forcing, respectively, as shown in Figures 
\ref{fig:iwaves2} and \ref{fig:iwaves3}.  Note that even with the use of the sponge layer,
some internal wave energy is reflected back from the left boundary and affects the internal
wave field shown in Figure \ref{fig:iwaves3}.  In addition to using \verb+sunplot+, printouts for
these  plots can be obtained with the 
\verb+plotslice.m+ m-file which can be downloaded from 

\medskip
\noindent
\mfiledownload.

\medskip
\noindent
\insertfig{0.75}{figures/iwaves1}{The initial salinity (density) field for the internal wave 
test case.}{fig:iwaves1}
\insertfig{0.75}{figures/iwaves2}{The horizontal velocity field  (mm s$^{-1}$) after one $M_2$ tidal period for
the internal wave test case.}{fig:iwaves2}
\insertfig{0.75}{figures/iwaves3}{The horizontal velocity field (mm s$^{-1}$) after two $M_2$ tidal periods for
the internal wave test case.}{fig:iwaves3}

%\subsection{Wetting and drying (bug release!)} \label{sec:wettinganddrying}

%\subsubsection{Grid}
%\subsubsection{Initial conditions}
%\subsubsection{Boundary conditions}
%\subsubsection{Running the test}
